<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Tools - Weavara Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #ffffff;
            padding: 24px 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link {
            display: inline-block;
            color: #ffffff;
            text-decoration: none;
            margin-bottom: 12px;
            opacity: 0.9;
            font-size: 14px;
        }

        .header .back-link:hover {
            opacity: 1;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #1e40af;
        }

        .tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
        }

        .tab-content {
            background: #ffffff;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #1e40af;
        }

        button {
            background: #1e40af;
            color: #ffffff;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #1e3a8a;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .validation-result {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .validation-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .validation-result.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .validation-result.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #1e40af;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 13px;
        }
    </style>
</head>
<body>
    {% if staging_mode %}
    <div style="background: #dc2626; color: white; padding: 10px 20px; text-align: center; font-weight: 600; font-size: 14px; letter-spacing: 0.5px;">
        ‚ö†Ô∏è STAGING
    </div>
    {% endif %}
    <div class="header">
        <a href="/admin?token={{ token }}" class="back-link">‚Üê Back to Dashboard</a>
        <h1>üìë Research Tools</h1>
        <p>Generate AI summaries of earnings transcripts, press releases, and company profiles</p>
    </div>

    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('generate-research', event)">Generate Research</button>
            <button class="tab" onclick="switchTab('research-library', event)">Research Library</button>
        </div>

        <!-- Generate Research Tab (Unified) -->
        <div id="generate-research-tab" class="tab-content">
            <h2>Generate Research</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Enter a ticker to see all available research and generate comprehensive AI analyses.
            </p>

            <!-- Ticker Input -->
            <div class="input-group">
                <label>Ticker Symbol <span style="color: #dc2626;">*</span></label>
                <input type="text" id="unified-ticker" placeholder="e.g., AAPL, TSLA, RY.TO"
                       style="text-transform: uppercase;">
                <button onclick="loadTickerResearch()" style="margin-top: 8px;">Load Research Options</button>
            </div>

            <!-- Loading State -->
            <div id="research-loading" style="display:none; text-align: center; padding: 40px;">
                <div class="loading"></div>
                <p style="color: #6b7280; margin-top: 12px;">Loading available research...</p>
            </div>

            <!-- Error State -->
            <div id="research-error" style="display:none; margin-top: 20px; padding: 16px;
                                            background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b;">Error</p>
                <p id="research-error-message" style="margin: 8px 0 0 0; color: #991b1b; font-size: 14px;"></p>
            </div>

            <!-- Research Sections Container -->
            <div id="research-sections" style="display:none; margin-top: 32px;">
                <!-- Company Info Header -->
                <div id="company-header" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                                                 color: white; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                    <h3 id="company-name" style="margin: 0 0 8px 0; font-size: 24px;"></h3>
                    <p id="company-details" style="margin: 0; opacity: 0.9; font-size: 14px;"></p>
                </div>

                <!-- 10-K Annual Reports Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìÑ 10-K Annual Reports (<span id="count-10k">0</span> available)
                    </summary>
                    <div id="list-10k" style="margin-top: 16px;"></div>
                </details>

                <!-- 10-Q Quarterly Reports Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìä 10-Q Quarterly Reports (<span id="count-10q">0</span> available)
                    </summary>
                    <div id="list-10q" style="margin-top: 16px;"></div>
                </details>

                <!-- Earnings Transcripts Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üéôÔ∏è Earnings Transcripts (<span id="count-transcripts">0</span> available)
                    </summary>
                    <div id="list-transcripts" style="margin-top: 16px;"></div>
                </details>

                <!-- Press Releases Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üì∞ Press Releases (<span id="count-press-releases">0</span> available)
                    </summary>
                    <div id="list-press-releases" style="margin-top: 16px;"></div>
                </details>

                <!-- 8-K SEC Releases Section (NEW) -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìã 8-K SEC Releases (<span id="count-8ks">0</span> available)
                    </summary>
                    <div id="list-8ks" style="margin-top: 16px;"></div>
                </details>

                <!-- Investor Presentations Section -->
                <details open style="margin-bottom: 20px; background: white; border-radius: 8px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <summary style="font-size: 18px; font-weight: 600; color: #1e40af; cursor: pointer; user-select: none;">
                        üìé Investor Presentations (Drag & Drop PDF)
                    </summary>
                    <div style="margin-top: 16px;">
                        <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">
                            Upload investor presentation PDFs for AI analysis using Gemini multimodal vision.
                        </p>
                        <div id="pdf-drop-zone"
                             style="border: 2px dashed #e5e7eb; border-radius: 8px; padding: 32px; text-align: center;
                                    background: #f9fafb; cursor: pointer; transition: all 0.2s;"
                             ondrop="handlePDFDrop(event)" ondragover="handlePDFDragOver(event)" ondragleave="handlePDFDragLeave(event)"
                             onclick="document.getElementById('pdf-file-input').click()">
                            <p style="font-size: 16px; color: #6b7280; margin: 0;">
                                üìé Drag and drop PDF here or click to browse
                            </p>
                            <p style="font-size: 12px; color: #9ca3af; margin: 8px 0 0 0;">
                                Supports earnings decks, investor days, analyst days, and conference presentations
                            </p>
                        </div>
                        <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;" onchange="handlePDFFileSelect(event)">

                        <!-- PDF Upload Form (hidden until file selected) -->
                        <div id="pdf-upload-form" style="display:none; margin-top: 20px; padding: 20px; background: #f0fdf4; border-radius: 8px;">
                            <p style="margin: 0 0 16px 0; font-weight: 600;">Selected: <span id="pdf-filename"></span></p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Presentation Date</label>
                                    <input type="date" id="pdf-date" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type</label>
                                    <select id="pdf-type" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                                        <option value="earnings">Earnings Deck</option>
                                        <option value="investor_day">Investor Day</option>
                                        <option value="analyst_day">Analyst Day</option>
                                        <option value="conference">Conference Presentation</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Title</label>
                                <input type="text" id="pdf-title" placeholder="e.g., Q3 2024 Earnings Deck"
                                       style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 4px;">
                            </div>
                            <button onclick="uploadAndAnalyzePDF()"
                                    style="margin-top: 20px; background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                                           color: white; border: none; padding: 12px 24px; border-radius: 8px;
                                           font-weight: 600; cursor: pointer;">
                                üöÄ Upload & Analyze with Gemini
                            </button>
                            <button onclick="cancelPDFUpload()"
                                    style="margin-left: 12px; background: #6b7280; color: white; border: none;
                                           padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <!-- Research Library Tab (renamed from View Profiles) -->
        <div id="research-library-tab" class="tab-content" style="display:none;">
            <h2>Research Library</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                Browse, search, and manage all generated research documents.
            </p>

            <!-- Research Type Filter -->
            <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                <label style="font-weight: 600; color: #374151; margin: 0;">View:</label>
                <select id="research-type-filter" onchange="switchResearchType()"
                        style="padding: 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; cursor: pointer; flex: 0 0 200px;">
                    <option value="10k">10-K Profiles</option>
                    <option value="10q">10-Q Profiles</option>
                    <option value="presentations">Investor Presentations</option>
                    <option value="transcripts">Earnings Transcripts</option>
                    <option value="8k_filings">8-K Filings</option>
                    <option value="parsed_prs">Company Releases</option>
                    <option value="snapshots">Financial Snapshots</option>
                </select>

                <!-- Search Box -->
                <input
                    type="text"
                    id="profiles-search"
                    placeholder="üîç Search by ticker..."
                    oninput="filterProfiles()"
                    style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;"
                    onfocus="this.style.borderColor='#1e40af'"
                    onblur="this.style.borderColor='#e5e7eb'"
                />
            </div>

            <div id="profiles-loading" style="text-align: center; padding: 40px;">
                <p style="color: #6b7280;">Loading...</p>
            </div>

            <div id="profiles-list" style="display:none;">
                <p id="profiles-count" style="margin-bottom: 16px; color: #6b7280; font-size: 14px;"></p>

                <div style="overflow-x: auto;">
                    <table id="research-table" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white;">
                            <tr id="table-headers">
                                <!-- Headers will be inserted dynamically -->
                            </tr>
                        </thead>
                        <tbody id="profiles-table-body">
                            <!-- Rows will be inserted dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="profiles-error" style="display:none; padding: 20px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 4px; margin-top: 20px;">
                <p style="margin: 0; font-weight: 600; color: #991b1b;">Error loading research</p>
                <p id="profiles-error-message" style="margin: 8px 0 0 0; color: #991b1b; font-size: 14px;"></p>
            </div>
        </div>

        <!-- Profile Viewer Modal -->
        <div id="profile-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
            <div style="background: white; margin: 40px auto; max-width: 1000px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;">
                <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
                    <h2 id="modal-title" style="margin: 0; color: #1e3a8a;">Company Profile</h2>
                    <button onclick="closeProfileModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                </div>

                <div id="modal-content" style="padding: 24px; max-height: 70vh; overflow-y: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 13px; line-height: 1.6; color: #374151; background-color: #f9fafb;">
                    <style>
                        #modal-content table {
                            table-layout: fixed;
                            width: 100%;
                            border-collapse: collapse;
                            margin: 16px 0;
                            font-size: 12px;
                        }
                        #modal-content th {
                            background-color: #1e40af;
                            color: white;
                            padding: 8px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-weight: 600;
                        }
                        #modal-content td {
                            padding: 8px;
                            border: 1px solid #ddd;
                        }
                        #modal-content tr:nth-child(even) {
                            background-color: #f3f4f6;
                        }
                        #modal-content td:first-child, #modal-content th:first-child {
                            width: 40%;
                        }
                        #modal-content h1 {
                            color: #1e40af;
                            font-size: 20px;
                            margin-top: 24px;
                            margin-bottom: 12px;
                            border-bottom: 2px solid #1e40af;
                            padding-bottom: 6px;
                        }
                        #modal-content h2 {
                            color: #1e3a8a;
                            font-size: 18px;
                            margin-top: 20px;
                            margin-bottom: 10px;
                        }
                        #modal-content h3 {
                            color: #1e40af;
                            font-size: 16px;
                            margin-top: 16px;
                            margin-bottom: 8px;
                        }
                        #modal-content code {
                            background-color: #e5e7eb;
                            padding: 2px 4px;
                            border-radius: 3px;
                            font-family: monospace;
                            font-size: 12px;
                        }
                        #modal-content pre {
                            background-color: #1f2937;
                            color: #f3f4f6;
                            padding: 12px;
                            border-radius: 4px;
                            overflow-x: auto;
                        }
                        #modal-content pre code {
                            background-color: transparent;
                            padding: 0;
                            color: #f3f4f6;
                        }
                    </style>
                    <!-- Profile markdown will be rendered here -->
                </div>

                <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="downloadProfile()" style="background: #1e40af; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Download Markdown
                    </button>
                    <button onclick="closeProfileModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Weavara Research Tools | <a href="mailto:support@weavara.io" style="color: #1e40af;">Contact Support</a></p>
    </div>

    <script>
        const token = '{{ token }}';

        // =============================================================================
        // TAB SWITCHING
        // =============================================================================

        function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }

        // =============================================================================
        // =============================================================================
        // UNIFIED GENERATE RESEARCH TAB
        // =============================================================================

        let currentTickerData = null;
        let selectedPDFFile = null;

        async function loadTickerResearch() {
            const ticker = document.getElementById('unified-ticker').value.toUpperCase().trim();

            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            // Show loading, hide others
            document.getElementById('research-loading').style.display = 'block';
            document.getElementById('research-error').style.display = 'none';
            document.getElementById('research-sections').style.display = 'none';

            try {
                const response = await fetch(`/api/admin/ticker-research-status?ticker=${ticker}&token=${token}`);
                const data = await response.json();

                if (data.status === 'success') {
                    currentTickerData = data;

                    // Fetch 8-Ks from SEC Edgar (separate from FMP data)
                    let eightKData = null;
                    try {
                        const eightKResponse = await fetch(`/api/sec-validate-ticker?ticker=${ticker}`);
                        eightKData = await eightKResponse.json();
                    } catch (error) {
                        console.error('Failed to fetch 8-Ks:', error);
                        eightKData = { valid: false, available_8ks: [] };
                    }

                    displayTickerResearch(data, eightKData);
                } else {
                    document.getElementById('research-loading').style.display = 'none';
                    document.getElementById('research-error').style.display = 'block';
                    document.getElementById('research-error-message').textContent = data.message || 'Failed to load research options';
                }
            } catch (error) {
                document.getElementById('research-loading').style.display = 'none';
                document.getElementById('research-error').style.display = 'block';
                document.getElementById('research-error-message').textContent = error.message;
            }
        }

        function displayTickerResearch(data, eightKData) {
            // Hide loading, show sections
            document.getElementById('research-loading').style.display = 'none';
            document.getElementById('research-sections').style.display = 'block';

            // Update company header
            document.getElementById('company-name').textContent = `${data.company_name} (${data.ticker})`;
            document.getElementById('company-details').textContent = `Industry: ${data.industry || 'N/A'}`;

            // Update counts
            document.getElementById('count-10k').textContent = data.available_10k.length;
            document.getElementById('count-10q').textContent = data.available_10q.length;
            document.getElementById('count-transcripts').textContent = data.available_transcripts.length;
            document.getElementById('count-press-releases').textContent = data.available_press_releases.length;
            document.getElementById('count-8ks').textContent = (eightKData && eightKData.valid) ? eightKData.available_8ks.length : 0;

            // Populate lists
            populate10KList(data.available_10k, data.ticker);
            populate10QList(data.available_10q, data.ticker);
            populateTranscriptsList(data.available_transcripts, data.ticker);
            populatePressReleasesList(data.available_press_releases, data.ticker);
            populate8KList((eightKData && eightKData.valid) ? eightKData.available_8ks : [], data.ticker, eightKData?.cik);
        }

        function populate10KList(items, ticker) {
            const container = document.getElementById('list-10k');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No 10-K filings available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>FY${item.year}</strong> (Filed: ${item.filing_date})
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: '10k'})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: '10k'})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>FY${item.year}</strong>
                                ${item.filing_date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Filed: ${formatShortDate(item.filing_date)}</span>` : ''}
                            </div>
                            <button onclick="generate10K('${ticker}', ${item.year}, '${item.filing_date}', '${item.period_end_date || ''}', '${item.sec_html_url}')"
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        function populate10QList(items, ticker) {
            const container = document.getElementById('list-10q');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No 10-Q filings available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                const key = `${item.year}-Q${item.quarter}`;
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Q${item.quarter} FY${item.year}</strong> (Filed: ${item.filing_date})
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: '10q', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: '10q', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Q${item.quarter} FY${item.year}</strong>
                                ${item.filing_date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Filed: ${formatShortDate(item.filing_date)}</span>` : ''}
                            </div>
                            <button onclick="generate10Q('${ticker}', ${item.year}, ${item.quarter}, '${item.filing_date}', '${item.period_end_date || ''}', '${item.sec_html_url}')"
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        function populateTranscriptsList(items, ticker) {
            const container = document.getElementById('list-transcripts');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No earnings transcripts available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.label}</strong>
                                ${item.call_date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Filed: ${formatShortDate(item.call_date)}</span>` : ''}
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div>
                                <button onclick="viewDocument({ticker: '${ticker}', type: 'transcripts', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    View
                                </button>
                                <button onclick="deleteDocument({ticker: '${ticker}', type: 'transcripts', quarter: ${item.quarter}, year: ${item.year}})"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${item.label}</strong>
                                ${item.call_date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Filed: ${formatShortDate(item.call_date)}</span>` : ''}
                            </div>
                            <button onclick="generateTranscript('${ticker}', ${item.quarter}, ${item.year})"
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        function populatePressReleasesList(items, ticker) {
            const container = document.getElementById('list-press-releases');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No press releases available from FMP.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                // Truncate and escape title to prevent HTML injection
                const rawTitle = item.title || '';
                const truncatedTitle = rawTitle.length > 80 ? rawTitle.substring(0, 80) + '...' : rawTitle;
                const displayTitle = escapeHtml(truncatedTitle);

                if (item.generated) {
                    const genDate = new Date(item.generated).toLocaleDateString();
                    // Use JSON.stringify for safe onclick parameters
                    const deleteParams = JSON.stringify({
                        ticker: ticker,
                        type: 'press_releases',
                        report_date: item.date,
                        pr_title: item.title
                    }).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${displayTitle}</strong>
                                ${item.date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Date: ${formatShortDate(item.date)}</span>` : ''}
                                <span style="color: #059669; font-size: 13px; margin-left: 12px;">‚úì Generated on ${genDate}</span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="viewDocument({ticker: '${ticker}', type: 'press_releases', report_date: '${item.date}'})"
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    View
                                </button>
                                <button onclick='deleteDocument(${deleteParams})'
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Use JSON.stringify for safe onclick parameters
                    const genParams = JSON.stringify({
                        ticker: ticker,
                        date: item.date,
                        title: item.title
                    }).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${displayTitle}</strong>
                                ${item.date ? `<span style="color: #6b7280; font-size: 12px; margin-left: 8px;">Date: ${formatShortDate(item.date)}</span>` : ''}
                            </div>
                            <button onclick='generatePressReleaseSafe(${genParams})'
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        // Helper function to format date as MM/DD/YY
        function formatShortDate(dateStr) {
            if (!dateStr) return '';
            // Strip timestamp if present (e.g., "2025-08-05 00:00:00" ‚Üí "2025-08-05")
            const dateOnly = dateStr.split(' ')[0];
            const parts = dateOnly.split('-');
            if (parts.length !== 3) return dateStr;
            const [year, month, day] = parts;
            return `${month}/${day}/${year.slice(2)}`;
        }

        // 8-K SEC Releases population function
        function populate8KList(items, ticker, cik) {
            const container = document.getElementById('list-8ks');
            if (items.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No 8-K filings available from SEC Edgar.</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                const displayTitle = item.title && item.title.length > 80 ? item.title.substring(0, 80) + '...' : (item.title || '8-K Filing');

                if (item.has_summary) {
                    // Build action buttons for generated 8-K (match library pattern)
                    // Note: No exhibit_number = delete ALL exhibits for this accession
                    // cascade=true to also delete associated parsed PRs
                    const docId = JSON.stringify({
                        ticker: ticker,
                        type: '8k_filings',
                        accession_number: item.accession_number,
                        // No exhibit_number - deletes all exhibits for this accession
                        cascade: true  // Generate Research deletes both raw and parsed
                    }).replace(/"/g, '&quot;');

                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>${item.filing_date} ‚úÖ</div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick='viewDocument(${docId}); event.stopPropagation();'
                                        style="background: #1e40af; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    View
                                </button>
                                <button onclick='emailDocument(${docId}); event.stopPropagation();'
                                        style="background: #059669; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Email
                                </button>
                                <button onclick='deleteDocument(${docId}); event.stopPropagation();'
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                } else if (item.error) {
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; margin: 0 0 4px 0;">${item.filing_date}</p>
                                    <p style="margin: 0; color: #dc2626; font-size: 13px;">‚ö†Ô∏è Error: ${item.error}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Encode all parameters as JSON object with full HTML escaping
                    const params = JSON.stringify({
                        ticker: ticker,
                        cik: cik || '',
                        accession_number: item.accession_number,
                        filing_date: item.filing_date,
                        documents_url: item.documents_url || '',
                        item_codes: item.item_codes || ''
                    }).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div>${item.filing_date}</div>
                            <button onclick='generate8KSafe(${params})'
                                    style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                Generate
                            </button>
                        </div>
                    `;
                }
            }).join('');
        }

        // 8-K generation function
        async function generate8K(ticker, cik, accessionNumber, filingDate, documentsUrl, itemCodes) {
            alert(`Starting 8-K exhibit processing for ${ticker} (${filingDate}). Processing all EX-99.* exhibits...`);

            try {
                const response = await fetch('/api/admin/generate-8k-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        cik: cik,
                        accession_number: accessionNumber,
                        filing_date: filingDate,
                        documents_url: documentsUrl,
                        item_codes: itemCodes
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert(`‚úÖ 8-K exhibit processing job created! Job ID: ${result.job_id}\n\nProcessing all EX-99.* exhibits (~1 min). You'll receive separate emails for each exhibit.`);
                } else {
                    alert(`‚ùå Failed to create job: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Wrapper function to safely unpack JSON-encoded parameters
        function generate8KSafe(params) {
            generate8K(
                params.ticker,
                params.cik,
                params.accession_number,
                params.filing_date,
                params.documents_url,
                params.item_codes
            );
        }

        // Generation functions (using existing backend endpoints)
        async function generate10K(ticker, year, filingDate, periodEndDate, secHtmlUrl) {
            // Use existing company profile generation endpoint
            alert(`Starting 10-K generation for ${ticker} FY${year}. This will take 5-10 minutes...`);

            try{
                const response = await fetch('/api/admin/generate-company-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        fiscal_year: year,
                        filing_date: filingDate,
                        period_end_date: periodEndDate,
                        sec_html_url: secHtmlUrl
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert(`10-K generation started! Job ID: ${result.job_id}. Refresh the page in 5-10 minutes to see the result.`);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert(`Failed to start generation: ${error.message}`);
            }
        }

        async function generate10Q(ticker, year, quarter, filingDate, periodEndDate, secHtmlUrl) {
            alert(`Starting 10-Q generation for ${ticker} Q${quarter} ${year}. This will take 5-10 minutes...`);

            try {
                const response = await fetch('/api/admin/generate-10q-profile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        fiscal_year: year,
                        fiscal_quarter: `Q${quarter}`,
                        filing_date: filingDate,
                        period_end_date: periodEndDate,
                        sec_html_url: secHtmlUrl
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert(`10-Q generation started! Job ID: ${result.job_id}. Refresh the page in 5-10 minutes to see the result.`);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                alert(`Failed to start generation: ${error.message}`);
            }
        }

        async function generateTranscript(ticker, quarter, year) {
            alert(`Generating transcript for ${ticker} Q${quarter} ${year}...`);

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'transcript',
                        quarter: quarter,
                        year: year
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('‚úÖ Transcript generated successfully! Check your email.');
                    loadTickerResearch(); // Reload to show updated status
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed: ${error.message}`);
            }
        }

        async function generatePressRelease(ticker, date, title) {
            alert(`Generating press release for ${ticker} on ${date}...`);

            try {
                const response = await fetch('/api/admin/generate-transcript-summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: token,
                        ticker: ticker,
                        report_type: 'press_release',
                        pr_date: date,
                        pr_title: title
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    alert('‚úÖ Press release summary generated! Check your email.');
                    loadTickerResearch(); // Reload
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed: ${error.message}`);
            }
        }

        // Safe wrapper that accepts JSON object (for escaped onclick handlers)
        function generatePressReleaseSafe(params) {
            generatePressRelease(params.ticker, params.date, params.title);
        }

        // PDF drag & drop handlers
        function handlePDFDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#1e40af';
            e.target.style.background = '#eff6ff';
        }

        function handlePDFDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#e5e7eb';
            e.target.style.background = '#f9fafb';
        }

        function handlePDFDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#e5e7eb';
            e.target.style.background = '#f9fafb';

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                selectedPDFFile = files[0];
                showPDFUploadForm(files[0].name);
            } else {
                alert('Please drop a PDF file');
            }
        }

        function handlePDFFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                selectedPDFFile = files[0];
                showPDFUploadForm(files[0].name);
            } else {
                alert('Please select a PDF file');
            }
        }

        function showPDFUploadForm(filename) {
            document.getElementById('pdf-filename').textContent = filename;
            document.getElementById('pdf-upload-form').style.display = 'block';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pdf-date').value = today;
        }

        function cancelPDFUpload() {
            selectedPDFFile = null;
            document.getElementById('pdf-upload-form').style.display = 'none';
            document.getElementById('pdf-file-input').value = '';
        }

        async function uploadAndAnalyzePDF() {
            if (!selectedPDFFile || !currentTickerData) {
                alert('Please select a PDF and load ticker first');
                return;
            }

            const date = document.getElementById('pdf-date').value;
            const type = document.getElementById('pdf-type').value;
            const title = document.getElementById('pdf-title').value;

            if (!date || !title) {
                alert('Please fill in all fields');
                return;
            }

            // Read file as base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Content = e.target.result.split(',')[1]; // Remove data:application/pdf;base64, prefix

                alert(`Uploading and analyzing ${selectedPDFFile.name}. This will take 5-10 minutes...`);

                try {
                    const response = await fetch('/api/admin/generate-presentation', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            token: token,
                            ticker: currentTickerData.ticker,
                            presentation_date: date,
                            presentation_type: type,
                            presentation_title: title,
                            file_content: base64Content,
                            file_name: selectedPDFFile.name
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        alert(`‚úÖ Presentation analysis started! Job ID: ${result.job_id}. Refresh the page in 5-10 minutes to see the result.`);
                        cancelPDFUpload(); // Clear form
                        loadTickerResearch(); // Reload to show updated status
                    } else {
                        alert(`‚ùå Error: ${result.message}`);
                    }
                } catch (error) {
                    alert(`‚ùå Failed: ${error.message}`);
                }
            };
            reader.readAsDataURL(selectedPDFFile);
        }

        // =============================================================================

        // VIEW PROFILES TAB - UNIFIED RESEARCH LIBRARY
        // =============================================================================

        let currentProfile = null;  // Store current document for download
        let currentResearchType = '10k';  // Current filter selection
        let allProfiles = [];  // Store all documents for filtering/sorting
        let currentSort = { column: 'ticker', direction: 'asc' };

        async function switchResearchType() {
            currentResearchType = document.getElementById('research-type-filter').value;
            await loadProfiles();
        }

        async function loadProfiles() {
            document.getElementById('profiles-loading').style.display = 'block';
            document.getElementById('profiles-list').style.display = 'none';
            document.getElementById('profiles-error').style.display = 'none';

            try {
                let endpoint, dataKey, params;

                switch (currentResearchType) {
                    case '10k':
                        endpoint = '/api/admin/company-profiles';
                        dataKey = 'profiles';
                        params = `token=${token}&filing_type=10-K`;
                        break;
                    case '10q':
                        endpoint = '/api/admin/company-profiles';
                        dataKey = 'profiles';
                        params = `token=${token}&filing_type=10-Q`;
                        break;
                    case 'presentations':
                        endpoint = '/api/admin/investor-presentations';
                        dataKey = 'presentations';
                        params = `token=${token}`;
                        break;
                    case 'transcripts':
                        endpoint = '/api/admin/transcripts';
                        dataKey = 'transcripts';
                        params = `token=${token}`;
                        break;
                    case 'press_releases':
                        endpoint = '/api/admin/press-releases';
                        dataKey = 'press_releases';
                        params = `token=${token}`;
                        break;
                    case '8k_filings':
                        endpoint = '/api/admin/8k-filings';
                        dataKey = 'filings';
                        params = `token=${token}`;
                        break;
                    case 'parsed_prs':
                        endpoint = '/api/admin/parsed-press-releases';
                        dataKey = 'parsed_prs';
                        params = `token=${token}`;
                        break;
                    case 'snapshots':
                        endpoint = '/api/admin/get-snapshots';
                        dataKey = 'snapshots';
                        params = `token=${token}`;
                        break;
                }

                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();

                if (data.status === 'success') {
                    displayProfiles(data[dataKey] || []);
                } else {
                    document.getElementById('profiles-loading').style.display = 'none';
                    document.getElementById('profiles-error').style.display = 'block';
                    document.getElementById('profiles-error-message').textContent = data.message || 'Failed to load research';
                }
            } catch (error) {
                document.getElementById('profiles-loading').style.display = 'none';
                document.getElementById('profiles-error').style.display = 'block';
                document.getElementById('profiles-error-message').textContent = error.message;
            }
        }

        function displayProfiles(profiles) {
            allProfiles = profiles;
            document.getElementById('profiles-loading').style.display = 'none';
            document.getElementById('profiles-list').style.display = 'block';

            const typeLabels = {
                '10k': '10-K profile',
                '10q': '10-Q profile',
                'presentations': 'investor presentation',
                'transcripts': 'transcript',
                'press_releases': 'press release',
                '8k_filings': '8-K filing',
                'parsed_prs': 'company release',
                'snapshots': 'financial snapshot',
            };
            const typeLabel = typeLabels[currentResearchType] || 'document';
            document.getElementById('profiles-count').textContent = `Found ${profiles.length} ${typeLabel}${profiles.length !== 1 ? 's' : ''}`;

            // Build headers dynamically
            const thead = document.getElementById('table-headers');
            thead.innerHTML = getTableHeaders(currentResearchType);

            const tbody = document.getElementById('profiles-table-body');
            tbody.innerHTML = '';

            if (profiles.length === 0) {
                const emptyMessages = {
                    '10k': 'No 10-K profiles generated yet. Create one in the "Company Profiles" tab!',
                    '10q': 'No 10-Q profiles generated yet. (Infrastructure ready, not wired to UI)',
                    'presentations': 'No investor presentations analyzed yet.',
                    'transcripts': 'No earnings transcripts generated yet. Create one in the "Earnings Transcripts" tab!',
                    'press_releases': 'No press releases generated yet. Create one in the "Press Releases" tab!',
                    'parsed_prs': 'No company releases generated yet. New FMP press releases and 8-K filings will appear here automatically.',
                    '8k_filings': 'No 8-K filings loaded yet.',
                    'snapshots': 'No financial snapshots saved yet. Generate one in the "Financial Snapshot" page and click Save!',
                };
                const colspan = (currentResearchType === '10k' || currentResearchType === '10q') ? '6' : '7';
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="padding: 40px; text-align: center; color: #6b7280;">${emptyMessages[currentResearchType]}</td></tr>`;
                return;
            }

            profiles.forEach(doc => {
                const row = document.createElement('tr');
                row.setAttribute('data-ticker', doc.ticker);
                row.style.borderBottom = '1px solid #e5e7eb';
                row.onmouseover = () => row.style.background = '#f9fafb';
                row.onmouseout = () => row.style.background = 'white';

                row.innerHTML = getTableRow(doc, currentResearchType);
                tbody.appendChild(row);
            });
        }

        function getTableHeaders(type) {
            const common = `
                <th onclick="sortTable('ticker')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">
                    Ticker <span id="sort-ticker" style="font-size: 10px;">‚ñº</span>
                </th>
            `;

            switch (type) {
                case '10k':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Company</th>
                        <th onclick="sortTable('fiscal_year')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">FY</th>
                        <th onclick="sortTable('generated_at')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Generated</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Tokens</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case '10q':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Company</th>
                        <th onclick="sortTable('fiscal_year')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Period</th>
                        <th onclick="sortTable('generated_at')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Generated</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Tokens</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case 'presentations':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Company</th>
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Title</th>
                        <th onclick="sortTable('presentation_date')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Date</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Type</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Pages</th>
                        <th onclick="sortTable('generated_at')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Analyzed</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case 'transcripts':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Quarter</th>
                        <th onclick="sortTable('report_date')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Report Date</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Words</th>
                        <th onclick="sortTable('generated_at')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Generated</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case 'press_releases':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Title</th>
                        <th onclick="sortTable('report_date')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Date</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Words</th>
                        <th onclick="sortTable('generated_at')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Generated</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case '8k_filings':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Date</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Exhibit</th>
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Description</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Items</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case 'parsed_prs':
                    return common + `
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Source</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Exhibit</th>
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Title</th>
                        <th onclick="sortTable('document_date')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Date</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Quarter</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">FY</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Chars</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
                case 'snapshots':
                    return common + `
                        <th style="padding: 10px; text-align: left; font-size: 13px;">Company</th>
                        <th onclick="sortTable('snapshot_date')" style="padding: 10px; text-align: left; cursor: pointer; font-size: 13px;">Snapshot Date</th>
                        <th style="padding: 10px; text-align: right; font-size: 13px;">Price</th>
                        <th style="padding: 10px; text-align: right; font-size: 13px;">Market Cap</th>
                        <th style="padding: 10px; text-align: center; font-size: 13px;">Actions</th>
                    `;
            }
        }

        // Helper to escape HTML special characters for safe display
        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function getTableRow(doc, type) {
            // Format date without time (just YYYY-MM-DD)
            const generatedDate = new Date(doc.generated_at).toLocaleDateString();

            switch (type) {
                case '10k':
                    const tokensIn10k = (doc.token_count_input || 0).toLocaleString();
                    const tokensOut10k = (doc.token_count_output || 0).toLocaleString();

                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${doc.ticker}</td>
                        <td style="padding: 10px; font-size: 12px;">${doc.company_name}</td>
                        <td style="padding: 10px; font-size: 12px;">${doc.fiscal_year}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 10px; text-align: center; color: #6b7280; font-size: 11px;">
                            ${tokensIn10k} / ${tokensOut10k}
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case '10q':
                    const tokensIn10q = (doc.token_count_input || 0).toLocaleString();
                    const tokensOut10q = (doc.token_count_output || 0).toLocaleString();

                    // Build period display with period_end_date if available
                    // NOTE: fiscal_quarter is already stored as "Q1", "Q2", etc. in database (VARCHAR)
                    let period;
                    if (doc.fiscal_quarter) {
                        // 10-Q - fiscal_quarter already has "Q" prefix
                        period = doc.period_end_date
                            ? `${doc.fiscal_quarter} ${doc.fiscal_year} (${formatShortDate(doc.period_end_date)})`
                            : `${doc.fiscal_quarter} ${doc.fiscal_year}`;
                    } else {
                        // 10-K
                        period = doc.period_end_date
                            ? `${doc.fiscal_year} (${formatShortDate(doc.period_end_date)})`
                            : doc.fiscal_year;
                    }

                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${doc.ticker}</td>
                        <td style="padding: 10px; font-size: 12px;">${doc.company_name}</td>
                        <td style="padding: 10px; font-size: 12px;">${period}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 10px; text-align: center; color: #6b7280; font-size: 11px;">
                            ${tokensIn10q} / ${tokensOut10q}
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'presentations':
                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${escapeHtml(doc.ticker)}</td>
                        <td style="padding: 10px; font-size: 12px;">${escapeHtml(doc.company_name) || 'N/A'}</td>
                        <td style="padding: 10px; font-size: 12px;">${escapeHtml(doc.presentation_title) || 'N/A'}</td>
                        <td style="padding: 10px; font-size: 12px;">${doc.presentation_date || 'N/A'}</td>
                        <td style="padding: 10px; text-align: center; font-size: 12px;">${escapeHtml(doc.presentation_type) || 'N/A'}</td>
                        <td style="padding: 10px; text-align: center; font-size: 12px;">${doc.page_count || 'N/A'}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'transcripts':
                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${doc.ticker}</td>
                        <td style="padding: 10px; font-size: 12px;">${doc.quarter_label}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${doc.report_date || 'N/A'}</td>
                        <td style="padding: 10px; text-align: center; font-size: 12px;">${(doc.word_count || 0).toLocaleString()}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'press_releases':
                    // Title truncation and escaping - increased to 100 chars for better readability
                    const prRawTitle = doc.title || '';
                    const prTruncated = prRawTitle.length > 100 ? prRawTitle.substring(0, 100) + '...' : prRawTitle;
                    const prTitle = escapeHtml(prTruncated) || 'Press Release';

                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${escapeHtml(doc.ticker)}</td>
                        <td style="padding: 10px; font-size: 12px; max-width: 450px;">${prTitle}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${doc.report_date || 'N/A'}</td>
                        <td style="padding: 10px; text-align: center; font-size: 12px;">${(doc.word_count || 0).toLocaleString()}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${generatedDate}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case '8k_filings':
                    const exhibitDesc = escapeHtml(doc.exhibit_description) || 'N/A';

                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${escapeHtml(doc.ticker)}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${formatShortDate(doc.filing_date) || 'N/A'}</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #1e40af; font-size: 13px;">${doc.exhibit_number || 'N/A'}</td>
                        <td style="padding: 10px; font-size: 12px; max-width: 500px;">${exhibitDesc}</td>
                        <td style="padding: 10px; text-align: center; color: #6b7280; font-size: 11px;">${doc.item_codes || 'Unknown'}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'parsed_prs':
                    // Truncate and escape title to prevent HTML injection - increased to 100 chars
                    const rawTitle = doc.document_title || '';
                    const truncatedTitle = rawTitle.length > 100 ? rawTitle.substring(0, 100) + '...' : rawTitle;
                    const parsedTitle = escapeHtml(truncatedTitle) || 'N/A';
                    // Format source type badge
                    const sourceTypeBadge = doc.source_type === '8k_exhibit'
                        ? '<span style="background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 3px; font-size: 10px;">8-K</span>'
                        : '<span style="background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 3px; font-size: 10px;">FMP</span>';
                    // Format date
                    const docDate = doc.document_date ? new Date(doc.document_date).toLocaleDateString() : 'N/A';
                    // Format exhibit number for 8-K, dash for FMP
                    const exhibitLabel = doc.source_type === '8k_exhibit' && doc.exhibit_number
                        ? `Ex ${doc.exhibit_number}`
                        : '‚Äî';
                    // Format fiscal period
                    const fiscalQuarter = doc.fiscal_quarter || '‚Äî';
                    const fiscalYear = doc.fiscal_year || '‚Äî';

                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${escapeHtml(doc.ticker)}</td>
                        <td style="padding: 10px; text-align: center;">${sourceTypeBadge}</td>
                        <td style="padding: 10px; text-align: center; font-family: monospace; font-size: 11px; color: #6b7280;">${exhibitLabel}</td>
                        <td style="padding: 10px; font-size: 12px; max-width: 450px;" title="${escapeHtml(rawTitle)}">${parsedTitle}</td>
                        <td style="padding: 10px; color: #6b7280; font-size: 12px;">${docDate}</td>
                        <td style="padding: 10px; text-align: center; font-family: monospace; font-size: 11px; color: #6b7280;">${fiscalQuarter}</td>
                        <td style="padding: 10px; text-align: center; font-family: monospace; font-size: 11px; color: #6b7280;">${fiscalYear}</td>
                        <td style="padding: 10px; text-align: center; font-size: 11px;">${(doc.char_count || 0).toLocaleString()}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
                case 'snapshots':
                    const snapshotDate = doc.snapshot_date ? new Date(doc.snapshot_date).toLocaleDateString() : 'N/A';
                    const priceStr = doc.current_price ? `$${doc.current_price.toFixed(2)}` : 'N/A';
                    const mcapStr = doc.market_cap ? formatMarketCap(doc.market_cap) : 'N/A';

                    return `
                        <td style="padding: 10px; font-weight: 600; color: #1e40af; font-size: 13px;">${escapeHtml(doc.ticker)}</td>
                        <td style="padding: 10px; font-size: 12px;">${escapeHtml(doc.company_name) || 'N/A'}</td>
                        <td style="padding: 10px; font-size: 12px;">${snapshotDate}</td>
                        <td style="padding: 10px; text-align: right; font-size: 12px;">${priceStr}</td>
                        <td style="padding: 10px; text-align: right; font-size: 12px;">${mcapStr}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${getActionButtons(doc, type)}
                        </td>
                    `;
            }
        }

        function formatMarketCap(value) {
            if (!value) return 'N/A';
            if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
            if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
            if (value >= 1e6) return `$${(value / 1e6).toFixed(0)}M`;
            return `$${value.toLocaleString()}`;
        }

        function renderSnapshotTable(data) {
            const annualCols = data.columns?.annual || [];
            const quarterlyCols = data.columns?.quarterly || [];
            const metrics = data.metrics || {};

            // Format value based on type
            function formatValue(value, format) {
                if (value === null || value === undefined) return '‚Äî';
                const isNeg = value < 0;
                const absVal = Math.abs(value);
                let text;
                if (format === 'dollar') text = `$${absVal.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                else if (format === 'percent') text = `${absVal.toFixed(1)}%`;
                else if (format === 'multiple') text = `${absVal.toFixed(1)}x`;
                else if (format === 'eps') text = `$${absVal.toFixed(2)}`;
                else if (format === 'shares') text = absVal >= 1000 ? `${(absVal/1000).toFixed(1)}B` : `${absVal.toFixed(0)}M`;
                else text = String(value);
                return isNeg ? `<span style="color:#dc2626">(${text})</span>` : text;
            }

            const metricDefs = [
                {section: 'Income Statement', items: [
                    {key: 'Sales', label: 'Sales', format: 'dollar'},
                    {key: 'EBITDA', label: 'EBITDA', format: 'dollar'},
                    {key: 'EBITDA Margin', label: 'EBITDA Margin', format: 'percent'},
                    {key: 'Revenue Y/Y', label: 'Revenue Y/Y', format: 'percent'},
                    {key: 'EBITDA Y/Y', label: 'EBITDA Y/Y', format: 'percent'},
                    {key: 'EPS', label: 'EPS (Diluted)', format: 'eps'},
                    {key: 'Shares Outstanding', label: 'Shares Out', format: 'shares'},
                ]},
                {section: 'Cash Flow', items: [
                    {key: 'OCF', label: 'Operating CF', format: 'dollar'},
                    {key: 'CapEx', label: 'CapEx', format: 'dollar'},
                    {key: 'Free Cash Flow', label: 'Free Cash Flow', format: 'dollar'},
                ]},
                {section: 'Balance Sheet', items: [
                    {key: 'Gross Debt', label: 'Gross Debt', format: 'dollar'},
                    {key: 'Cash', label: 'Cash', format: 'dollar'},
                    {key: 'Net Debt', label: 'Net Debt', format: 'dollar'},
                    {key: 'Net Leverage', label: 'Net Leverage', format: 'multiple'},
                ]},
                {section: 'Valuation', items: [
                    {key: 'Market Cap', label: 'Market Cap', format: 'dollar'},
                    {key: 'EV', label: 'EV', format: 'dollar'},
                    {key: 'EV/EBITDA', label: 'EV/EBITDA', format: 'multiple'},
                    {key: 'P/S', label: 'P/S', format: 'multiple'},
                    {key: 'FCF Yield', label: 'FCF Yield', format: 'percent'},
                    {key: 'Dividend Yield', label: 'Dividend Yield', format: 'percent'},
                ]},
            ];

            let html = `
                <div style="margin-bottom: 16px; color: #6b7280; font-size: 13px;">
                    <strong>Snapshot Date:</strong> ${data.snapshot_date || 'N/A'} |
                    <strong>Price:</strong> ${data.current_price ? '$' + data.current_price.toFixed(2) : 'N/A'} |
                    <strong>Market Cap:</strong> ${formatMarketCap(data.market_cap)}
                </div>
                <div style="overflow-x: auto;">
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                    <thead>
                        <tr style="background:#1e40af; color:white;">
                            <th style="padding:8px; text-align:left; white-space:nowrap;">Metric</th>
            `;

            annualCols.forEach(y => html += `<th style="padding:8px; text-align:right;">${y}</th>`);
            html += `<th style="background:#374151; width:5px;"></th>`;
            quarterlyCols.forEach(q => html += `<th style="padding:8px; text-align:right;">${q}</th>`);
            html += `</tr></thead><tbody>`;

            const totalCols = annualCols.length + quarterlyCols.length + 2;

            metricDefs.forEach(({section, items}) => {
                html += `<tr style="background:#f0f7ff;"><td colspan="${totalCols}" style="padding:8px; font-weight:700; color:#1e40af; border-top:2px solid #1e40af;">${section}</td></tr>`;
                items.forEach(({key, label, format}) => {
                    const m = metrics[key] || {};
                    html += `<tr style="border-bottom:1px solid #e5e7eb;"><td style="padding:8px; font-weight:600; background:#f9fafb;">${label}</td>`;
                    (m.annual || []).forEach(v => html += `<td style="padding:8px; text-align:right;">${formatValue(v, format)}</td>`);
                    for (let i = (m.annual || []).length; i < annualCols.length; i++) html += `<td style="padding:8px; text-align:right;">‚Äî</td>`;
                    html += `<td style="background:#e5e7eb;"></td>`;
                    (m.quarterly || []).forEach(v => html += `<td style="padding:8px; text-align:right;">${formatValue(v, format)}</td>`);
                    for (let i = (m.quarterly || []).length; i < quarterlyCols.length; i++) html += `<td style="padding:8px; text-align:right;">‚Äî</td>`;
                    html += `</tr>`;
                });
            });

            html += `</tbody></table></div>`;
            if (data.ebitda_method) html += `<p style="margin-top:12px; color:#6b7280; font-size:12px;"><strong>EBITDA Method:</strong> ${data.ebitda_method}</p>`;
            return html;
        }

        function getActionButtons(doc, type) {
            const docId = JSON.stringify({
                ticker: doc.ticker,
                type: type,
                fiscal_year: doc.fiscal_year,        // For 10-K and 10-Q
                fiscal_quarter: doc.fiscal_quarter,  // For 10-Q
                presentation_date: doc.presentation_date,
                quarter: doc.quarter,
                year: doc.year,
                report_date: doc.report_date,
                pr_title: doc.title,                 // For press releases (title field from doc)
                accession_number: doc.accession_number,  // For 8-K filings
                exhibit_number: doc.exhibit_number,      // For 8-K exhibit-level operations
                ai_provider: doc.ai_provider,        // Include ai_provider for transcript disambiguation
                id: doc.id,                          // For parsed_prs (direct ID)
                source_type: doc.source_type,        // For parsed_prs
                source_id: doc.source_id             // For parsed_prs
            }).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            return `
                <div style="display: flex; gap: 3px; justify-content: center; flex-wrap: nowrap;">
                    <button onclick='viewDocument(${docId}); event.stopPropagation();'
                            title="View"
                            style="background: #1e40af; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; white-space: nowrap;">
                        üëÅÔ∏è
                    </button>
                    <button onclick='emailDocument(${docId}); event.stopPropagation();'
                            title="Email to Me"
                            style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; white-space: nowrap;">
                        üìß
                    </button>
                    <button onclick='deleteDocument(${docId}); event.stopPropagation();'
                            title="Delete"
                            style="background: #dc2626; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; white-space: nowrap;">
                        üóëÔ∏è
                    </button>
                </div>
            `;
        }

        async function viewDocument(docInfo) {
            try {
                // Find document in current list
                const doc = allProfiles.find(d => {
                    if (docInfo.type === '10k') {
                        return d.ticker === docInfo.ticker && d.fiscal_year === docInfo.fiscal_year;
                    } else if (docInfo.type === '10q') {
                        return d.ticker === docInfo.ticker && d.fiscal_year === docInfo.fiscal_year && d.fiscal_quarter === docInfo.fiscal_quarter;
                    } else if (docInfo.type === 'presentations') {
                        return d.ticker === docInfo.ticker && d.presentation_date === docInfo.presentation_date;
                    } else if (docInfo.type === 'transcripts') {
                        // Include ai_provider to distinguish between Gemini and Sonnet versions
                        return d.ticker === docInfo.ticker && d.quarter === docInfo.quarter && d.year === docInfo.year && d.ai_provider === docInfo.ai_provider;
                    } else if (docInfo.type === 'press_releases') {
                        // Match by date AND title (multiple PRs can exist on same date)
                        return d.ticker === docInfo.ticker && d.report_date === docInfo.report_date && d.title === docInfo.pr_title;
                    } else if (docInfo.type === '8k_filings') {
                        return d.ticker === docInfo.ticker && d.accession_number === docInfo.accession_number && d.exhibit_number === docInfo.exhibit_number;
                    } else if (docInfo.type === 'parsed_prs') {
                        return d.id === docInfo.id;
                    } else if (docInfo.type === 'snapshots') {
                        return d.ticker === docInfo.ticker;
                    }
                });

                if (doc) {
                    currentProfile = doc;
                    currentProfile.type = docInfo.type; // Store type for download

                    // Set modal title
                    let title = '';
                    if (docInfo.type === '10k' || docInfo.type === '10q') {
                        title = `${doc.company_name} (${doc.ticker}) - FY${doc.fiscal_year}`;
                    } else if (docInfo.type === 'presentations') {
                        title = `${doc.company_name || doc.ticker} - ${doc.presentation_title || 'Presentation'} (${doc.presentation_date})`;
                    } else if (docInfo.type === 'transcripts') {
                        title = `${doc.ticker} Earnings Transcript - ${doc.quarter} ${doc.year}`;
                    } else if (docInfo.type === 'press_releases') {
                        title = `${doc.ticker} Press Release - ${doc.report_date}`;
                    } else if (docInfo.type === '8k_filings') {
                        title = `${doc.ticker} 8-K Filing - Exhibit ${doc.exhibit_number}: ${doc.exhibit_description} (${doc.filing_date})`;
                    } else if (docInfo.type === 'parsed_prs') {
                        const sourceLabel = doc.source_type === '8k_exhibit' ? '8-K' : 'FMP';
                        title = `${doc.ticker} Parsed PR (${sourceLabel}) - ${doc.document_title}`;
                    } else if (docInfo.type === 'snapshots') {
                        title = `${doc.company_name || doc.ticker} (${doc.ticker}) - Financial Snapshot`;
                    }
                    document.getElementById('modal-title').textContent = title;

                    // Get content (8-K uses raw_content which is already HTML)
                    let contentHtml;
                    if (docInfo.type === '8k_filings') {
                        // 8-K content is already HTML, use directly
                        contentHtml = doc.raw_content || 'No content available';
                    } else if (docInfo.type === 'parsed_prs') {
                        // Parsed PRs need to fetch full summary via API
                        try {
                            const response = await fetch(`/api/admin/parsed-press-release/${doc.id}?token=${token}`);
                            const data = await response.json();
                            if (data.status === 'success' && data.parsed_pr) {
                                const content = data.parsed_pr.parsed_summary || 'No content available';
                                contentHtml = markdownToHtml(content);
                                // Update currentProfile with full data for download
                                currentProfile = { ...currentProfile, ...data.parsed_pr };
                            } else {
                                contentHtml = '<p>Failed to load parsed summary</p>';
                            }
                        } catch (e) {
                            contentHtml = '<p>Error fetching parsed summary: ' + e.message + '</p>';
                        }
                    } else if (docInfo.type === 'snapshots') {
                        // Fetch full snapshot JSON from API
                        try {
                            const response = await fetch(`/api/admin/get-snapshot/${doc.ticker}?token=${token}`);
                            const snapshotData = await response.json();
                            if (snapshotData.ticker) {
                                contentHtml = renderSnapshotTable(snapshotData);
                                currentProfile = { ...currentProfile, snapshot_json: snapshotData };
                            } else {
                                contentHtml = '<p>Failed to load snapshot data</p>';
                            }
                        } catch (e) {
                            contentHtml = '<p>Error fetching snapshot: ' + e.message + '</p>';
                        }
                    } else {
                        // Other types use markdown, convert it
                        const content = doc.profile_markdown || doc.summary_text || 'No content available';
                        contentHtml = markdownToHtml(content);
                    }

                    document.getElementById('modal-content').innerHTML = contentHtml;
                    document.getElementById('profile-modal').style.display = 'block';
                }
            } catch (error) {
                alert('Failed to load document: ' + error.message);
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
            currentProfile = null;
        }

        function downloadProfile() {
            if (!currentProfile) return;

            let filename, content;
            const type = currentProfile.type || currentResearchType;

            if (type === '10k' || type === '10q') {
                filename = `${currentProfile.ticker}_${type.toUpperCase()}_FY${currentProfile.fiscal_year}.md`;
                content = currentProfile.profile_markdown;
            } else if (type === 'presentations') {
                filename = `${currentProfile.ticker}_Presentation_${currentProfile.presentation_date}.md`;
                content = currentProfile.profile_markdown;
            } else if (type === 'transcripts') {
                filename = `${currentProfile.ticker}_Transcript_Q${currentProfile.quarter}_${currentProfile.year}.md`;
                content = currentProfile.summary_text;
            } else if (type === 'press_releases') {
                filename = `${currentProfile.ticker}_PressRelease_${currentProfile.report_date}.md`;
                content = currentProfile.summary_text;
            } else if (type === '8k_filings') {
                filename = `${currentProfile.ticker}_8K_Exhibit_${currentProfile.exhibit_number}_${currentProfile.filing_date}.md`;
                content = currentProfile.raw_content || currentProfile.summary_text;
            } else if (type === 'parsed_prs') {
                const dateStr = currentProfile.document_date ? new Date(currentProfile.document_date).toISOString().split('T')[0] : 'unknown';
                filename = `${currentProfile.ticker}_ParsedPR_${currentProfile.source_type}_${dateStr}.md`;
                content = currentProfile.parsed_summary;
            }

            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function filterProfiles() {
            const searchQuery = document.getElementById('profiles-search').value.toLowerCase();
            const rows = document.querySelectorAll('#profiles-table-body tr');

            let visibleCount = 0;
            rows.forEach(row => {
                const ticker = row.getAttribute('data-ticker') || '';

                if (ticker.toLowerCase().includes(searchQuery)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            const typeLabels = {
                '10k': '10-K profile',
                '10q': '10-Q profile',
                'presentations': 'presentation',
                'transcripts': 'transcript',
                'press_releases': 'press release'
            };
            const typeLabel = typeLabels[currentResearchType] || 'document';

            const countText = searchQuery ?
                `Showing ${visibleCount} of ${allProfiles.length} ${typeLabel}${allProfiles.length !== 1 ? 's' : ''}` :
                `Found ${allProfiles.length} ${typeLabel}${allProfiles.length !== 1 ? 's' : ''}`;
            document.getElementById('profiles-count').textContent = countText;
        }

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update sort indicators
            document.querySelectorAll('[id^="sort-"]').forEach(el => {
                el.textContent = '‚óã';
            });
            const sortEl = document.getElementById(`sort-${column}`);
            if (sortEl) {
                sortEl.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
            }

            // Sort array
            const sorted = [...allProfiles].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (!aVal) return 1;
                if (!bVal) return -1;

                if (typeof aVal === 'string') {
                    return currentSort.direction === 'asc' ?
                        aVal.localeCompare(bVal) :
                        bVal.localeCompare(aVal);
                }

                return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
            });

            displayProfiles(sorted);

            const searchQuery = document.getElementById('profiles-search').value;
            if (searchQuery) {
                filterProfiles();
            }
        }

        async function deleteDocument(docInfo) {
            const docLabel = docInfo.type === '10q' ? `${docInfo.fiscal_quarter} ${docInfo.fiscal_year}` :
                           docInfo.type === '10k' ? `FY ${docInfo.fiscal_year}` :
                           docInfo.type === '8k_filings' ? `8-K Filing` :
                           docInfo.type === 'parsed_prs' ? `Parsed PR (${docInfo.source_type})` :
                           docInfo.type === 'snapshots' ? 'Financial Snapshot' :
                           docInfo.type;

            // Custom warning for parsed PRs (cascade delete)
            let confirmMsg = `Are you sure you want to delete ${docLabel} for ${docInfo.ticker}?\n\nThis action cannot be undone.`;
            if (docInfo.type === 'parsed_prs') {
                const sourceLabel = docInfo.source_type === '8k_exhibit' ? '8-K filing' : 'FMP press release';
                confirmMsg = `Delete ${docLabel} for ${docInfo.ticker}?\n\nThis will also delete the source ${sourceLabel}.\n\nThis action cannot be undone.`;
            }

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                let endpoint, body;

                if (docInfo.type === '10k') {
                    endpoint = '/api/admin/delete-sec-filing';
                    body = { token, ticker: docInfo.ticker, filing_type: '10-K', fiscal_year: docInfo.fiscal_year };
                } else if (docInfo.type === '10q') {
                    endpoint = '/api/admin/delete-sec-filing';
                    body = { token, ticker: docInfo.ticker, filing_type: '10-Q', fiscal_year: docInfo.fiscal_year, fiscal_quarter: docInfo.fiscal_quarter };
                } else if (docInfo.type === 'presentations') {
                    endpoint = '/api/admin/delete-investor-presentation';
                    body = { token, ticker: docInfo.ticker, presentation_date: docInfo.presentation_date };
                } else if (docInfo.type === 'transcripts') {
                    endpoint = '/api/admin/delete-transcript';
                    body = { token, ticker: docInfo.ticker, quarter: docInfo.quarter, year: docInfo.year, report_type: 'transcript', ai_provider: docInfo.ai_provider };
                } else if (docInfo.type === 'press_releases') {
                    endpoint = '/api/admin/delete-transcript';
                    body = { token, ticker: docInfo.ticker, report_date: docInfo.report_date, pr_title: docInfo.pr_title, report_type: 'press_release' };
                } else if (docInfo.type === '8k_filings') {
                    endpoint = '/api/admin/delete-8k-filing';
                    body = {
                        token,
                        ticker: docInfo.ticker,
                        accession_number: docInfo.accession_number,
                        exhibit_number: docInfo.exhibit_number,
                        cascade: docInfo.cascade || false  // Cascade from Generate Research tab
                    };
                } else if (docInfo.type === 'parsed_prs') {
                    endpoint = '/api/admin/delete-parsed-pr';
                    body = { token, id: docInfo.id };
                } else if (docInfo.type === 'snapshots') {
                    endpoint = '/api/admin/delete-snapshot';
                    body = { token, ticker: docInfo.ticker };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úÖ ${data.message}`);
                    loadProfiles();
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to delete: ${error.message}`);
            }
        }

        async function emailDocument(docInfo) {
            const docLabel = docInfo.type === '10q' ? `${docInfo.fiscal_quarter} ${docInfo.fiscal_year}` :
                           docInfo.type === '10k' ? `FY ${docInfo.fiscal_year}` :
                           docInfo.type === 'snapshots' ? 'Financial Snapshot' :
                           docInfo.type.replace('_', ' ');

            if (!confirm(`Send ${docLabel} for ${docInfo.ticker} to your email?`)) {
                return;
            }

            try {
                let endpoint, body;

                if (docInfo.type === '10k') {
                    endpoint = '/api/admin/email-sec-filing';
                    body = { token, ticker: docInfo.ticker, filing_type: '10-K', fiscal_year: docInfo.fiscal_year };
                } else if (docInfo.type === '10q') {
                    endpoint = '/api/admin/email-sec-filing';
                    body = { token, ticker: docInfo.ticker, filing_type: '10-Q', fiscal_year: docInfo.fiscal_year, fiscal_quarter: docInfo.fiscal_quarter };
                } else if (docInfo.type === 'snapshots') {
                    endpoint = '/api/admin/email-snapshot';
                    body = { token, ticker: docInfo.ticker };
                } else {
                    endpoint = '/api/admin/email-research';
                    body = {
                        token,
                        ticker: docInfo.ticker,
                        type: docInfo.type === 'transcripts' ? 'transcript' :
                              docInfo.type === 'press_releases' ? 'press_release' :
                              docInfo.type === 'presentations' ? 'presentation' :
                              docInfo.type === '8k_filings' ? '8k_filing' :
                              docInfo.type === 'parsed_prs' ? 'parsed_pr' : docInfo.type,
                        id: docInfo.id,                     // Include for parsed_prs (direct ID lookup)
                        presentation_date: docInfo.presentation_date,
                        quarter: docInfo.quarter,
                        year: docInfo.year,
                        report_date: docInfo.report_date,
                        pr_title: docInfo.pr_title,         // Include for press release identification
                        ai_provider: docInfo.ai_provider,   // Include for transcript disambiguation
                        accession_number: docInfo.accession_number,  // Include for 8-K identification
                        exhibit_number: docInfo.exhibit_number       // Include for 8-K exhibit-level identification
                    };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úÖ ${data.message}`);
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Failed to email: ${error.message}`);
            }
        }

        // Simple markdown to HTML converter
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Headers
            html = html.replace(/^# (.*$)/gim, '<h1 style="margin-top: 24px; margin-bottom: 12px; color: #1e3a8a; font-size: 28px;">$1</h1>');
            html = html.replace(/^## (.*$)/gim, '<h2 style="margin-top: 20px; margin-bottom: 10px; color: #1e40af; font-size: 22px;">$1</h2>');
            html = html.replace(/^### (.*$)/gim, '<h3 style="margin-top: 16px; margin-bottom: 8px; color: #2563eb; font-size: 18px;">$1</h3>');

            // Bold and italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Lists
            html = html.replace(/^\* (.*$)/gim, '<li style="margin-left: 20px; margin-bottom: 6px;">$1</li>');
            html = html.replace(/(<li.*<\/li>)/s, '<ul style="margin: 12px 0;">$1</ul>');

            // Line breaks
            html = html.replace(/\n\n/g, '</p><p style="margin-bottom: 12px; line-height: 1.6;">');
            html = '<p style="margin-bottom: 12px; line-height: 1.6;">' + html + '</p>';

            return html;
        }

        // Enhanced switchTab to load profiles when View Profiles tab is opened
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName, event) {
            if (originalSwitchTab) {
                originalSwitchTab(tabName, event);
            } else {
                // Fallback if original doesn't exist
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabName + '-tab').style.display = 'block';
                if (event) event.target.classList.add('active');
            }

            // Load profiles when View Profiles tab is opened
            if (tabName === 'research-library') {
                loadProfiles();
            }
        };

        // Close modal on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeProfileModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('profile-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });
    </script>
</body>
</html>
